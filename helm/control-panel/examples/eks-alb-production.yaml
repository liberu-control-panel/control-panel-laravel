# AWS EKS Production Configuration with Application Load Balancer
# Optimized for AWS EKS using ALB with health checks and sticky sessions

replicaCount: 3

ingress:
  enabled: true
  className: "alb"
  annotations:
    # ALB configuration
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    
    # Load balancer attributes
    alb.ingress.kubernetes.io/load-balancer-attributes: |
      idle_timeout.timeout_seconds=300,
      routing.http2.enabled=true,
      routing.http.drop_invalid_header_fields.enabled=true,
      routing.http.xff_client_port.enabled=true
    
    # Health checks
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    alb.ingress.kubernetes.io/healthcheck-port: traffic-port
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "2"
    alb.ingress.kubernetes.io/success-codes: "200-399"
    
    # Target group attributes (sticky sessions)
    alb.ingress.kubernetes.io/target-group-attributes: |
      stickiness.enabled=true,
      stickiness.type=lb_cookie,
      stickiness.lb_cookie.duration_seconds=3600,
      deregistration_delay.timeout_seconds=30,
      slow_start.duration_seconds=30
    
    # SSL/TLS
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    # alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:region:account:certificate/xxxxx
    
    # Security
    # IMPORTANT: Replace with your actual security group ID before deployment
    # Example: alb.ingress.kubernetes.io/security-groups: "sg-0123456789abcdef0"
    # alb.ingress.kubernetes.io/security-groups: "sg-xxxxxxxxx"
    # alb.ingress.kubernetes.io/wafv2-acl-arn: arn:aws:wafv2:region:account:regional/webacl/name/id

service:
  type: ClusterIP
  port: 80
  sessionAffinity: ClientIP
  sessionAffinityTimeout: 3600

resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 50
  targetCPUUtilizationPercentage: 60
  targetMemoryUtilizationPercentage: 75

# Use EBS storage class for AWS
persistence:
  enabled: true
  storageClass: "gp3"
  size: 20Gi

# Queue workers
queue:
  enabled: true
  replicaCount: 5
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 256Mi

# Octane for high performance
octane:
  enabled: true
  server: roadrunner
  replicaCount: 5
  workers: 8
  resources:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 512Mi
